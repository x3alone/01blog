<div class="app-container" [class.dark-mode]="themeService.darkMode()">

  <!-- GLOBAL TOP NAVIGATION -->
  <header class="app-top-nav">
    <div class="nav-links">
      <!-- Home Link as Logo replacement -->
      <a routerLink="/home" class="nav-item" title="Home" routerLinkActive="active">
        <mat-icon>home</mat-icon>
      </a>
    </div>

    <div class="nav-links">
      @if (loggedIn()) {

      <!-- SEARCH BAR (Logged In Only) -->
      <div class="search-container">
        <div class="search-input-wrapper" [class.focused]="isSearchFocused()">
          <mat-icon class="search-icon">search</mat-icon>
          <input type="text" placeholder="Search users..." [(ngModel)]="searchQuery" (input)="onSearchInput()"
            (focus)="onSearchFocus()" (blur)="onSearchBlur()" class="search-input">
        </div>

        @if (showSearchResults()) {
        <div class="search-dropdown">
          @for (user of searchResults(); track user.id) {
          <div class="search-result-item" (click)="selectSearchedUser(user.id)">
            <div class="result-avatar">
              @if (user.avatarUrl) {
              <img [src]="user.avatarUrl">
              } @else {
              {{ user.username.charAt(0).toUpperCase() }}
              }
            </div>
            <span class="result-username">{{ user.username }}</span>
          </div>
          }
          @if (searchResults().length === 0 && searchQuery().length > 0) {
          <div class="no-results">No users found</div>
          }
        </div>
        }
      </div>

      <!-- Dashboard Link (Admin Only) -->
      @if (isAdmin()) {
      <a routerLink="/dashboard" class="nav-item dashboard-link">
        <div class="icon-box">
          <mat-icon>dashboard</mat-icon>
        </div>
      </a>
      }

      <!-- Notifications -->
      <div class="nav-item notif-wrapper">
        <button (click)="toggleNotifications()" class="icon-btn bell-btn" title="Notifications">
          <mat-icon>notifications</mat-icon>
          @if (unreadCount() > 0) {
          <span class="badge">{{ unreadCount() }}</span>
          }
        </button>

        @if (showNotifications()) {
        <div class="notification-dropdown">
          <h3>Notifications</h3>
          <div class="notif-list">
            @for (notif of notifications(); track notif.id) {
            <div class="notif-item" [class.unread]="!notif.read">
              {{ notif.message }}
            </div>
            }
            @if (notifications().length === 0) {
            <div class="empty-notif">No new notifications</div>
            }
          </div>
        </div>
        }
      </div>

      <!-- Dark Mode Toggle -->
      <button (click)="themeService.toggleTheme()" class="icon-btn theme-btn" title="Toggle Theme">
        @if (themeService.darkMode()) {
        <!-- Sun Icon -->
        <mat-icon>light_mode</mat-icon>
        } @else {
        <!-- Moon Icon -->
        <mat-icon>dark_mode</mat-icon>
        }
      </button>

      <!-- Profile Link -->
      <a [routerLink]="['/user', currentUserId()]" class="nav-item profile-link" title="My Profile"
        routerLinkActive="active">
        <div class="user-avatar-small">
          @if (currentUserAvatar()) {
          <img [src]="currentUserAvatar()" class="avatar-img-small">
          } @else {
          {{ currentUsername().charAt(0).toUpperCase() }}
          }
        </div>
      </a>

      <!-- Logout -->
      <button (click)="logout()" class="nav-item logout-btn" title="Logout">
        <mat-icon>logout</mat-icon>
      </button>
      } @else {
      <!-- Public User Links -->
      <a routerLink="/login" class="nav-item text-link">Login</a>
      <a routerLink="/register" class="nav-item text-link emphasize">Register</a>
      }
    </div>
  </header>

  <!-- MAIN CONTENT AREA -->
  <style>
    .avatar-img-small {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
  </style>
  <div class="main-wrapper">
    <router-outlet></router-outlet>
  </div>

</div>
<div class="sky-background"></div>
<app-toast></app-toast>
<app-confirmation-modal></app-confirmation-modal>