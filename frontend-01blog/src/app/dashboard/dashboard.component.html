<div class="dashboard-shell">
  <h2 class="dashboard-title">Admin Dashboard</h2>

  <!-- HUB VIEW: Main state when no specific view is selected -->
  @if (currentView === 'hub') {
  <div class="dashboard-hub">
    <div class="hub-card" (click)="setView('users')">
      <div class="icon">
        <div class="icon">
          <mat-icon class="stroke-indigo-500" style="font-size: 48px; width: 48px; height: 48px;">group</mat-icon>
        </div>
      </div>
      <h3>Manage Users</h3>
      <p>View, ban, or promote users.</p>
    </div>

    <div class="hub-card" (click)="setView('reports')">
      <div class="icon">
        <div class="icon">
          <mat-icon class="stroke-red-500" style="font-size: 48px; width: 48px; height: 48px;">report_problem</mat-icon>
        </div>
      </div>
      <h3>Report Center</h3>
      <p>Moderation queue for posts and users.</p>
    </div>

    <div class="hub-card" (click)="setView('posts')">
      <div class="icon">
        <div class="icon">
          <mat-icon class="stroke-green-500"
            style="font-size: 48px; width: 48px; height: 48px;">library_books</mat-icon>
        </div>
      </div>
      <h3>Manage Posts</h3>
      <p>View all posts, hide, or delete.</p>
    </div>
  </div>
  }

  <!-- USERS VIEW -->
  @if (currentView === 'users') {
  <div class="view-header">
    <button (click)="setView('hub')" class="back-btn">← Back</button>
    <h3>User Management</h3>
  </div>

  <div class="data-list fade-in">
    @if(isLoading()) { <p>Loading users...</p> }
    @for (user of users(); track user.id) {
    <!--  Users view keeps simpler structure, but adapted to new grid logic slightly if needed or kept simple flex -->
    <div class="list-item user-item">
      <div class="item-main">
        <span class="main-text" [ngClass]="{
            'admin-name': user.role === 'ADMIN',
            'banned-name': user.banned
          }">
          <!-- Role Icon (White/Neutral) -->
          @if(user.role === 'ADMIN') {
          <mat-icon class="mr-1" style="font-size: 18px; width: 18px; height: 18px;">verified_user</mat-icon>
          } @else if(user.banned) {
          <mat-icon class="mr-1" style="font-size: 18px; width: 18px; height: 18px;">block</mat-icon>
          } @else {
          <mat-icon class="mr-1" style="font-size: 18px; width: 18px; height: 18px;">person</mat-icon>
          }
          {{ user.username }}
          <span class="sub-text block">ID: {{ user.id }} • {{ user.email }}</span>
        </span>
      </div>

      <div class="actions users-top-right">
        @if (user.role !== 'ADMIN') {
        @if (user.banned) {
        <!-- BANNED: Show Only UNBAN -->
        <button (click)="unbanUser(user.id)" class="action-icon-btn" title="Unban">
          <!-- Unlock/Check icon -->
          <!-- Unlock/Check icon -->
          <mat-icon style="font-size: 18px; width: 18px; height: 18px;">lock_open</mat-icon>
        </button>
        } @else {
        <!-- ACTIVE USER: Ban or Promote -->
        <button (click)="banUser(user.id)" class="action-icon-btn" title="Ban">
          <mat-icon style="font-size: 18px; width: 18px; height: 18px;">block</mat-icon>
        </button>
        <button (click)="promoteUser(user.id)" class="action-icon-btn" title="Promote to Admin">
          <!-- Arrow Up -->
          <!-- Arrow Up -->
          <mat-icon style="font-size: 18px; width: 18px; height: 18px;">arrow_upward</mat-icon>
        </button>
        }
        } @else {
        <!-- DEMOTE: Arrow Down -->
        <button (click)="demoteUser(user.id)" class="action-icon-btn" title="Demote to User">
          <mat-icon style="font-size: 18px; width: 18px; height: 18px;">arrow_downward</mat-icon>
        </button>
        }
      </div>
    </div>
    }
  </div>
  }

  <!-- REPORTS VIEW -->
  @if (currentView === 'reports') {
  <div class="view-header">
    <button (click)="setView('hub')" class="back-btn">← Back</button>
    <h3>Reported Posts</h3>
  </div>

  <div class="data-list fade-in">
    @if(isLoading()) { <p>Loading reports...</p> }
    @if (reports().length === 0 && !isLoading()) { <p>No reports found.</p> }

    @for (report of reports(); track report.id) {
    <div class="list-item report-item grid-layout">
      <!-- LEFT: Main Info -->
      <div class="item-content">
        <div class="header-row">
          <span class="report-badge"
            style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); overflow-wrap: anywhere; word-break: break-word;">{{
            report.reason }}</span>
          @if (report.reportedPostId) {
          <span class="sub-text">on Post #{{ report.reportedPostId }} • by @{{ report.reporterUsername }}</span>
          } @else {
          <span class="sub-text">on User @{{ report.reportedUsername }} (ID: {{report.reportedUserId}}) • by @{{
            report.reporterUsername }}</span>
          }
        </div>

        @if (report.reportedPostId) {
        <p class="main-text mt-2" style="color: white;">Reported Post: {{ report.reportedPostTitle }}</p>
        <div class="reported-content mt-2 p-3 bg-gray-100 rounded text-sm text-gray-700" style="color: #ffffff;">
          {{ report.reportedPostContent | slice:0:150 }}{{ report.reportedPostContent.length > 150 ? '...' : '' }}
        </div>
        } @else if (report.reportedUserId) {
        <p class="sub-text" style="color: white;">• Reason Details: {{ report.details }}</p>
        }
      </div>


      <!-- MIDDLE/RIGHT: Media Preview -->
      <div class="item-media">
        @if(report.reportedPostMediaUrl) {
        @if(report.reportedPostMediaType === 'video') {
        <video [src]="report.reportedPostMediaUrl" class="media-thumb"
          (click)="openLightbox(report.reportedPostMediaUrl, 'video')"></video>
        } @else {
        <img [src]="report.reportedPostMediaUrl" class="media-thumb" alt="Reported Media"
          (click)="openLightbox(report.reportedPostMediaUrl, 'image')">
        }
        }
      </div>

      <!-- ABSOLUTE RIGHT: Meta & Actions -->
      <div class="item-meta">
        <span class="timestamp">{{ report.timestamp | date:'short' }}</span>
      </div>

      <div class="actions top-right">
        <!-- Dismiss (Check/X) -->
        <button (click)="dismissReport(report.id)" class="action-icon-btn" title="Dismiss Report">
          <mat-icon style="font-size: 18px; width: 18px; height: 18px;">close</mat-icon>
        </button>
        <!-- Delete Post (Trash) -->

        <!-- Ban User - Only for User Reports
        @if(report.reportedUserId) {
        <button (click)="banUser(report.reportedUserId)" class="action-icon-btn ban-btn" title="Ban User">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
          </svg>
        </button>
        } -->

        <!-- Delete Post  Only for Post Reports -->
        @if(report.reportedPostId) {
        <button (click)="deleteReportedPost(report.reportedPostId, report.id)" class="action-icon-btn"
          title="Delete Post & Resolve">
          <mat-icon style="font-size: 18px; width: 18px; height: 18px;">delete</mat-icon>
        </button>
        }
      </div>
    </div>
    }
  </div>
  }

  <!-- POSTS VIEW -->
  @if (currentView === 'posts') {
  <div class="view-header">
    <button (click)="setView('hub')" class="back-btn">← Back</button>
    <h3>All Posts</h3>
  </div>

  <div class="data-list fade-in">
    @if(isLoading()) { <p>Loading posts...</p> }
    @if (posts().length === 0 && !isLoading()) { <p>No posts found.</p> }

    @for (post of posts(); track post.id) {
    <div class="list-item post-item grid-layout">
      <!-- LEFT: Main Info -->
      <div class="item-content">
        <div class="header-row">
          <span class="author-badge">@ {{ post.username }}</span>
          @if(post.hidden) { <span class="status-badge hidden">HIDDEN</span> }
        </div>

        <p class="main-text mt-2">{{ post.title }}</p>

        <div class="post-snippet">
          {{ post.content | slice:0:100 }}{{ post.content.length > 100 ? '...' : '' }}
        </div>
      </div>

      <!-- ABSOLUTE RIGHT: Meta -->
      <div class="item-meta">
        <span class="timestamp">{{ post.createdAt | date:'short' }}</span>
      </div>

      <!-- MIDDLE/RIGHT: Media Preview -->
      <div class="item-media">
        @if(post.mediaUrl) {
        @if(post.mediaType === 'video') {
        <video [src]="post.mediaUrl" class="media-thumb" (click)="openLightbox(post.mediaUrl, 'video')"></video>
        } @else {
        <img [src]="post.mediaUrl" class="media-thumb" alt="Post Media" (click)="openLightbox(post.mediaUrl, 'image')">
        }
        }
      </div>


      <!-- ACTIONS: Top Right -->
      <div class="actions top-right">
        <!-- HIDE BUTTON -->
        <button (click)="togglePostVisibility(post)" class="action-icon-btn" [title]="post.hidden ? 'Unhide' : 'Hide'">
          @if(post.hidden) {
          <!-- Eye Off (Hidden) -> Click to Show -->
          <mat-icon style="font-size: 18px; width: 18px; height: 18px;">visibility_off</mat-icon>
          } @else {
          <!-- Eye (Visible) -> Click to Hide -->
          <mat-icon style="font-size: 18px; width: 18px; height: 18px;">visibility</mat-icon>
          }
        </button>

        <button (click)="adminDeletePost(post.id)" class="action-icon-btn delete-btn" title="Delete Post">
          <mat-icon style="font-size: 18px; width: 18px; height: 18px;">delete</mat-icon>
        </button>
      </div>
    </div>
    }
  </div>
  }

  <!-- LIGHTBOX MODAL -->
  @if(isLightboxOpen) {
  <div class="lightbox-overlay" (click)="closeLightbox()">
    <div class="lightbox-content" (click)="$event.stopPropagation()">
      <button class="lightbox-close" (click)="closeLightbox()">&times;</button>

      @if(selectedMediaType === 'video') {
      <video [src]="selectedMediaUrl" controls autoplay class="lightbox-media"></video>
      } @else {
      <img [src]="selectedMediaUrl" class="lightbox-media">
      }
    </div>
  </div>
  }

</div>