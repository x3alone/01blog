<div class="dashboard-shell">
  <h2 class="dashboard-title">Admin Dashboard</h2>

  @if (currentView === 'hub') {
  <div class="dashboard-hub">
    <div class="hub-card" (click)="setView('users')">
      <div class="icon-container">
        <mat-icon class="icon-indigo icon-large">group</mat-icon>
      </div>
      <h3>Manage Users</h3>
      <p>View, ban, or promote users.</p>
    </div>

    <div class="hub-card" (click)="setView('reports')">
      <div class="icon-container">
        <mat-icon class="icon-red icon-large">report_problem</mat-icon>
      </div>
      <h3>Report Center</h3>
      <p>Moderation queue for posts and users.</p>
    </div>

    <div class="hub-card" (click)="setView('posts')">
      <div class="icon-container">
        <mat-icon class="icon-green icon-large">library_books</mat-icon>
      </div>
      <h3>Manage Posts</h3>
      <p>View all posts, hide, or delete.</p>
    </div>
  </div>
  }

  @if (currentView === 'users') {
  <div class="view-header">
    <button (click)="setView('hub')" class="back-btn">← Back</button>
    <h3>User Management</h3>
  </div>

  <div class="data-list fade-in">
    @if(isLoading()) { <p>Loading users...</p> }
    @for (user of users(); track user.id) {
    <div class="list-item user-item">
      <div class="item-main">
        <span class="main-text" [ngClass]="{'admin-name': user.role === 'ADMIN', 'banned-name': user.banned}">
          @if(user.role === 'ADMIN') {
          <mat-icon class="margin-right-sm icon-small">verified_user</mat-icon>
          } @else if(user.banned) {
          <mat-icon class="margin-right-sm icon-small">block</mat-icon>
          } @else {
          <mat-icon class="margin-right-sm icon-small">person</mat-icon>
          }
          {{ user.username }}
          <span class="sub-text display-block">ID: {{ user.id }} • {{ user.email }}</span>
        </span>
      </div>

      <div class="actions users-top-right">
        @if (user.role !== 'ADMIN') {
          @if (user.banned) {
            <button (click)="unbanUser(user.id)" class="action-icon-btn" title="Unban">
              <mat-icon class="icon-small">lock_open</mat-icon>
            </button>
          } @else {
            <button (click)="banUser(user.id)" class="action-icon-btn" title="Ban">
              <mat-icon class="icon-small">block</mat-icon>
            </button>
            <button (click)="promoteUser(user.id)" class="action-icon-btn" title="Promote to Admin">
              <mat-icon class="icon-small">arrow_upward</mat-icon>
            </button>
          }
        } @else {
          <button (click)="demoteUser(user.id)" class="action-icon-btn" title="Demote to User">
            <mat-icon class="icon-small">arrow_downward</mat-icon>
          </button>
        }
      </div>
    </div>
    }
  </div>
  }

  @if (currentView === 'reports') {
  <div class="view-header">
    <button (click)="setView('hub')" class="back-btn">← Back</button>
    <h3>Reported Posts</h3>
  </div>

  <div class="data-list fade-in">
    @if(isLoading()) { <p>Loading reports...</p> }
    @if (reports().length === 0 && !isLoading()) { <p>No reports found.</p> }

    @for (report of reports(); track report.id) {
    <div class="list-item report-item grid-layout">
      <div class="item-content">
        <div class="header-row">
          <span class="report-badge">{{ report.reason }}</span>
          @if (report.reportedPostId) {
          <span class="sub-text">on Post #{{ report.reportedPostId }} • by @{{ report.reporterUsername }}</span>
          } @else {
          <span class="sub-text">on User @{{ report.reportedUsername }} (ID: {{report.reportedUserId}}) • by @{{ report.reporterUsername }}</span>
          }
        </div>

        @if (report.reportedPostId) {
        <p class="main-text margin-top-md light-text">Reported Post: {{ report.reportedPostTitle }}</p>
        <div class="reported-content-box">
          {{ report.reportedPostContent | slice:0:150 }}{{ report.reportedPostContent.length > 150 ? '...' : '' }}
        </div>
        } @else if (report.reportedUserId) {
        <p class="sub-text light-text">• Reason Details: {{ report.details }}</p>
        }
      </div>

      <div class="item-media">
        @if(report.reportedPostMediaUrl) {
          @if(report.reportedPostMediaType === 'video') {
            <video [src]="report.reportedPostMediaUrl" class="media-thumb" (click)="openLightbox(report.reportedPostMediaUrl, 'video')"></video>
          } @else {
            <img [src]="report.reportedPostMediaUrl" class="media-thumb" alt="Reported Media" (click)="openLightbox(report.reportedPostMediaUrl, 'image')">
          }
        }
      </div>

      <div class="item-meta">
        <span class="timestamp">{{ report.timestamp | date:'short' }}</span>
      </div>

      <div class="actions top-right">
        <button (click)="dismissReport(report.id)" class="action-icon-btn" title="Dismiss Report">
          <mat-icon class="icon-small">close</mat-icon>
        </button>
        @if(report.reportedPostId) {
        <button (click)="deleteReportedPost(report.reportedPostId, report.id)" class="action-icon-btn" title="Delete Post & Resolve">
          <mat-icon class="icon-small">delete</mat-icon>
        </button>
        }
      </div>
    </div>
    }
  </div>
  }

  @if (currentView === 'posts') {
  <div class="view-header">
    <button (click)="setView('hub')" class="back-btn">← Back</button>
    <h3>All Posts</h3>
  </div>

  <div class="data-list fade-in">
    @for (post of posts(); track post.id) {
    <div class="list-item post-item grid-layout">
      <div class="item-content">
        <div class="header-row">
          <span class="author-badge">@ {{ post.username }}</span>
          @if(post.hidden) { <span class="status-badge hidden">HIDDEN</span> }
        </div>
        <p class="main-text margin-top-md">{{ post.title }}</p>
        <div class="post-snippet">
          {{ post.content | slice:0:100 }}{{ post.content.length > 100 ? '...' : '' }}
        </div>
      </div>

      <div class="item-meta">
        <span class="timestamp">{{ post.createdAt | date:'short' }}</span>
      </div>

      <div class="item-media">
        @if(post.mediaUrl) {
          @if(post.mediaType === 'video') {
            <video [src]="post.mediaUrl" class="media-thumb" (click)="openLightbox(post.mediaUrl, 'video')"></video>
          } @else {
            <img [src]="post.mediaUrl" class="media-thumb" alt="Post Media" (click)="openLightbox(post.mediaUrl, 'image')">
          }
        }
      </div>

      <div class="actions top-right">
        <button (click)="togglePostVisibility(post)" class="action-icon-btn" [title]="post.hidden ? 'Unhide' : 'Hide'">
          <mat-icon class="icon-small">{{ post.hidden ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        <button (click)="adminDeletePost(post.id)" class="action-icon-btn delete-btn" title="Delete Post">
          <mat-icon class="icon-small">delete</mat-icon>
        </button>
      </div>
    </div>
    }
  </div>
  }

  @if(isLightboxOpen) {
  <div class="lightbox-overlay" (click)="closeLightbox()">
    <div class="lightbox-content" (click)="$event.stopPropagation()">
      <button class="lightbox-close" (click)="closeLightbox()">&times;</button>
      @if(selectedMediaType === 'video') {
        <video [src]="selectedMediaUrl" controls autoplay class="lightbox-media"></video>
      } @else {
        <img [src]="selectedMediaUrl" class="lightbox-media">
      }
    </div>
  </div>
  }
</div>