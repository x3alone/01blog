<div class="main-content">

  @if (isLoading()) {
  <div class="loading-message">Loading profile...</div>
  } @else if (profile()) {

  <div class="profile-layout">

    <!-- PROFILE CARD -->
    <div class="profile-card">
      <div class="cover-photo"></div>

      <div class="profile-content">
        <div class="profile-top">
          <div class="avatar-lg">
            @if (isEditing()) {
            <div class="edit-avatar-overlay">
              <label class="avatar-upload-label">
                <input type="file" (change)="onFileSelected($event)" accept="image/*" class="avatar-input-hidden">
                <div class="avatar-wrapper">
                  <img [src]="editForm().avatarUrl || profile()?.avatarUrl" class="avatar-img-edit">
                  <div class="overlay-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                      </path>
                      <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                  </div>
                </div>
              </label>
            </div>
            } @else {
            @if (profile()?.avatarUrl) {
            <img [src]="profile()?.avatarUrl" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
            } @else {
            {{ profile()?.username?.charAt(0)?.toUpperCase() }}
            }
            }
          </div>

        </div>

        <h1 class="username-title">
          {{ profile()?.username }}
          @if (profile()?.role === 'ADMIN') { <span class="admin-tag">Admin</span>
        }
      </h1>

        @if (isEditing()) {
        <div class="edit-form-container">
          <div class="form-group">
            <label>About Me</label>
            <textarea [(ngModel)]="editForm().aboutMe" placeholder="Tell us about yourself..."
              class="about-input"></textarea>
          </div>
          
          <div class="edit-actions">
            <button (click)="saveEdit()" class="save-btn">Save Change</button>
            <button (click)="cancelEdit()" class="cancel-btn">Cancel</button>
          </div>
        </div>
      } @else {
        @if (profile()?.aboutMe) {
          <p class="about-me">{{ profile()?.aboutMe }}</p>
        }
        @if (isOwnProfile()) {
          <button (click)="startEdit()" class="edit-profile-btn">Edit Profile</button>
        }
      }
      
      <div class="stats-bar">
        <div class="stat-item">
          <span class="stat-val">{{ posts().length }}</span>
          <span class="stat-label">Thoughts</span>
        </div>
        <div class="stat-item">
          <span class="stat-val">{{ profile()?.followersCount || 0 }}</span>
          <span class="stat-label">Followers</span>
        </div>
        <div class="stat-item">
          <span class="stat-val">{{ profile()?.followingCount || 0 }}</span>
          <span class="stat-label">Following</span>
        </div>
        <div class="action-area">
          @if (currentUser() && currentUser() !== profile()?.username) {
          <button (click)="toggleFollow()" class="follow-btn" [class.unfollow]="isFollowing()">
            {{ isFollowing() ? 'Unfollow' : 'Follow' }}
          </button>
          }
        </div>
      </div>
    </div>
  </div>
  
    <!-- POSTS -->
    <h2 class="section-title">Latest Thoughts</h2>

    <div class="users-posts">
      @for (post of posts(); track post.id) {
      <div class="post-card">
        <span class="post-date">{{ post.createdAt | date:'mediumDate' }}</span>
        <h3>{{ post.title }}</h3>
        <p>{{ post.content }}</p>
        @if (post.mediaUrl) {
        <div class="media-container">
          <img [src]="post.mediaUrl" style="max-width: 100%; border-radius: 8px;">
        </div>
        }
      </div>
      }
    </div>

  </div>

  } @else {
  <div class="not-found-message">User not found.</div>
  }
</div>